<?php
session_start();
require_once '../database/db_connect.php';
require_once '../database/alojamentos.php';

$db = getDatabaseConnection();

$viagem_id = $_POST['viagem_id'];
$nome = trim($_POST['nome']);
$localizacao = trim($_POST['localizacao']);
$tipo = $_POST['tipo'];
$data_inicio = $_POST['data_inicio'];
$data_fim = $_POST['data_fim'] ?? null;
$rating = $_POST['rating'] ?? null;
$comentario = trim($_POST['comentario'] ?? null);

if (!$nome || !$localizacao || !$tipo || !$data_inicio) {
    $_SESSION['error'] = "Todos os campos obrigatórios devem ser preenchidos.";
    header("Location: ../viagem.php?id=" . $viagem_id);
    exit;
}


// Verificar se o alojamento já existe (nome + localização)
$stmt = $db->prepare('SELECT D.id AS detalhe_id FROM Detalhes D JOIN Detalhes_alojamento DA ON D.id = DA.id WHERE D.nome = ? AND D.localizacao = ?');
$stmt->execute([$nome, $localizacao]);
$detalhe = $stmt->fetch(PDO::FETCH_ASSOC);

if ($detalhe) {
    $detalhe_id = $detalhe['detalhe_id'];
} else {
    // Criar novo detalhe de alojamento
    $detalhe_id = insertDetalheAlojamento($db, $nome, $localizacao, $tipo);
}

// Inserir alojamento associado à viagem
$alojamento_id = insertAlojamento($db, $viagem_id, $detalhe_id, $data_inicio, $data_fim);

// Se houver rating, adicionar feedback
if ($rating !== null && $rating !== '') {
    adicionarFeedbackAlojamento($db, $alojamento_id, $rating, $comentario);
}

$_SESSION['success'] = "Alojamento adicionado com sucesso!";
header("Location: ../viagem.php?id=" . $viagem_id);
exit;
?>